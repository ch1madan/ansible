---
- name: Bootstrap Debian 13 after reinstall
  hosts: all
  become: true

  vars:
    packages:
      - sudo
      - vim
      - mc
      - nload
      - wget
      - rsync
      - htop
      - iptables
      - iptables-persistent
      - git
      - net-tools
      - curl
      - pwgen
      - whois
      - dnsutils
      - tmux

    directories:
      - { path: "/usr/data/src", mode: "0755" }
      - { path: "/home/trash", mode: "0777" }
      - { path: "/home/logs", mode: "0755" }
      - { path: "/home/domains", mode: "0755" }
      - { path: "/home/ch1madan", mode: "0755" }

    users:
      - { name: "domains", home: "/home/domains" }
      - { name: "ch1madan", home: "/home/ch1madan" }

  tasks:

    - name: Create 1GB swapfile with correct permissions
      ansible.builtin.shell: |
        dd if=/dev/zero of=/var/swapfile bs=1M count=921
        chmod 600 /var/swapfile
        mkswap /var/swapfile
        swapon /var/swapfile
      args:
        creates: /var/swapfile
      become: true

    - name: Ensure swap in fstab
      ansible.builtin.mount:
        name: none
        src: /var/swapfile
        fstype: swap
        opts: sw
        state: present
      become: true

    - name: Clean apt cache
      apt:
        clean: yes

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Full upgrade
      apt:
        upgrade: dist

    - name: Autoremove unused packages
      apt:
        autoremove: yes

    - name: Install base packages
      apt:
        name: "{{ packages }}"
        state: present

    - name: Create system users with custom home
      user:
        name: "{{ item.name }}"
        home: "{{ item.home }}"
        create_home: yes
        shell: /bin/bash
      loop: "{{ users }}"

    - name: Create required directories
      file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
      loop: "{{ directories }}"

    - name: Configure SSH daemon
      blockinfile:
        path: /etc/ssh/sshd_config
        backup: yes
        block: |
#          Port 
          PasswordAuthentication no
          ListenAddress 0.0.0.0
          PermitRootLogin prohibit-password
          ClientAliveInterval 60
          ClientAliveCountMax 10
          TCPKeepAlive yes
      notify: Restart SSH

    - name: Configure root .bashrc
      copy:
        dest: /root/.bashrc
        owner: root
        group: root
        mode: "0644"
        content: |
          HISTCONTROL=ignoredups:ignorespace
          shopt -s histappend
          HISTSIZE=7777
          HISTFILESIZE=9000

          if [ -x /usr/bin/dircolors ]; then
              test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
              alias ls='ls --color=auto'
              alias ll='ls -AlF'
              alias la='ls -A'
              alias l='ls -CF'
              alias grep='grep --color=auto'
              alias fgrep='fgrep --color=auto'
              alias egrep='egrep --color=auto'
          fi
          export PS1="\[\e[33m\]\u\[\e[m\]@\[\e[36m\]\H\[\e[m\]:\w\[\e[31m\]\\$\[\e[m\] "

    - name: Configure root .vimrc
      copy:
        dest: /root/.vimrc
        owner: root
        group: root
        mode: "0644"
        content: |
          set mouse-=0
          syntax on

    - name: Set hostname
      hostname:
        name: SUSHKOV.ONLINE

  handlers:
    - name: Restart SSH
      service:
        name: ssh
        state: restarted
